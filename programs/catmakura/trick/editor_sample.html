<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Code editor</title>

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif;
  background:#f6f8fa;
  font-size:14px;
  color:#24292f;
  display:flex;
  flex-direction:column;
  height:100vh;
}

.global-header{
  background:#24292f;
  color:#fff;
  height:56px;
  display:flex;
  align-items:center;
  padding:0 16px;
  font-weight:600;
  flex-shrink:0;
}

.breadcrumb{
  background:#fff;
  padding:12px 24px;
  border-bottom:1px solid #d0d7de;
  flex-shrink:0;
}

.code-wrapper{
  margin:24px;
  border:1px solid #d0d7de;
  border-radius:6px;
  background:#fff;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  flex:1;
}

.code-header{
  background:#f6f8fa;
  padding:8px 16px;
  border-bottom:1px solid #d0d7de;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:12px;
  color:#57606a;
  flex-shrink:0;
}

.header-left{
  display:flex;
  gap:16px;
  align-items:center;
}

.header-right{
  display:flex;
  gap:12px;
  align-items:center;
}

button{
  padding:4px 10px;
  font-size:12px;
  border:1px solid #d0d7de;
  border-radius:6px;
  background:#fff;
  cursor:pointer;
}

button:hover{
  background:#f3f4f6;
}

button:disabled{
  opacity:0.6;
  cursor:not-allowed;
}

.code-area{
  display:flex;
  font-family:ui-monospace,SFMono-Regular,Consolas,"Liberation Mono",Menlo,monospace;
  font-size:13px;
  flex:1;
  overflow:hidden;
}

.line-numbers{
  background:#f6f8fa;
  padding:10px 8px;
  text-align:right;
  user-select:none;
  color:#57606a;
  overflow:hidden;
  line-height:1.6;
}

pre{
  margin:0;
  padding:10px;
  overflow:auto;
  white-space:pre;
  flex:1;
  line-height:1.6;
}

/* 画像・PDF表示用 */
.preview-container{
  padding:20px;
  flex:1;
  overflow:auto;
}

.preview-container img, .preview-container video{
  width:100%;
  height:auto;
  display:block;
}

.preview-container iframe{
  width:100%;
  height:100%;
  border:none;
}

.repolink {
  color: white;
  text-decoration: none;
}

.repolink:visited { color:white; }
.repolink:hover { color:#3c65b4; }
.repolink:active { color:#3c64b4; }
</style>
</head>
<body>

<div class="global-header">
  <a href="../profile.html" class="repolink">code editor</a>
</div>

<div class="breadcrumb" id="filePath">
  Loading...
</div>

<div class="code-wrapper">

  <div class="code-header">
    <div class="header-left">
      <div id="lineCount">0 lines</div>
      <div id="fileInfo">0 chars | 0 KB</div>
    </div>

    <div class="header-right">
      <button id="copyBtn">Copy</button>
      <button id="downloadBtn">Download</button>
    </div>
  </div>

  <div class="code-area" id="codeArea">
    <div class="line-numbers" id="lineNumbers"></div>
    <pre id="codeDisplay"></pre>
  </div>

</div>

<script>
const lineNumbers = document.getElementById("lineNumbers");
const lineCount = document.getElementById("lineCount");
const fileInfo = document.getElementById("fileInfo");
const codeDisplay = document.getElementById("codeDisplay");
const filePathDisplay = document.getElementById("filePath");
const downloadBtn = document.getElementById("downloadBtn");
const copyBtn = document.getElementById("copyBtn");
const codeArea = document.getElementById("codeArea");

const allowedFiles = [
  "sample.txt",
  "index.html",
  "README.md",
  "license.md",
  "image.png",
  "image.jpg",
  "image.jpeg",
  "image.gif",
  "file.pdf",
  "audio.mp3",
  "audio.wav",
  "video.mp4"
];

let currentText = "";
let currentFileName = "";

const params = new URLSearchParams(window.location.search);
currentFileName = params.get("file") || "sample.txt";

if(!allowedFiles.includes(currentFileName)){
  showError("403 - Access denied.");
} else {
  loadFile(currentFileName);
}

function loadFile(fileName){
  filePathDisplay.textContent = fileName;
  const extension = fileName.split(".").pop().toLowerCase();

  if(extension === "mp3"){
    showAudio(fileName);
    return;
  }

  fetch(fileName)
    .then(res => {
      if(!res.ok) throw new Error();
      return res.text();
    })
    .then(text => {
      currentText = text;
      codeDisplay.textContent = text;
      generateLines(text);
      document.title = fileName + " - editor";
    })
    .catch(() => {
      showError("File not found.");
    });
}

function showAudio(fileName){
  resetPreview();

  const container = document.createElement("div");
  container.className = "preview-container";

  const audio = document.createElement("audio");
  audio.src = fileName;
  audio.controls = true;
  audio.style.width = "100%";

  container.appendChild(audio);
  codeArea.appendChild(container);

  disableCodeUI();
}

function resetPreview(){
  lineNumbers.style.display = "none";
  codeDisplay.style.display = "none";
  codeArea.innerHTML = "";
}

function disableCodeUI(){
  lineCount.textContent = "Preview mode";
  fileInfo.textContent = "";
  copyBtn.disabled = true;
}

function showError(message){
  codeDisplay.textContent = message;
  lineNumbers.innerHTML = "";
  lineCount.textContent = "0 lines";
  fileInfo.textContent = "";
  downloadBtn.disabled = true;
  copyBtn.disabled = true;
  document.title = "error - editor";
}

function generateLines(text){
  const lines = text.split("\n");
  lineNumbers.innerHTML = lines.map((_,i)=> i+1).join("<br>");
  lineCount.textContent = lines.length + " lines";

  const charCount = text.length;
  const byteSize = new Blob([text]).size;
  fileInfo.textContent = `${charCount} chars | ${(byteSize/1024).toFixed(2)} KB`;
}

downloadBtn.addEventListener("click", () => {
  if(!currentFileName) return;
  const a = document.createElement("a");
  a.href = currentFileName;
  a.download = currentFileName;
  a.click();
});

copyBtn.addEventListener("click", async () => {
  if(!currentText) return;
  await navigator.clipboard.writeText(currentText);
  copyBtn.textContent = "Copied!";
  setTimeout(()=> copyBtn.textContent="Copy",1500);
});
</script>

</body>
</html>
